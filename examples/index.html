<head>
    <meta charset="utf-8" />
    <script src="stratum.js"></script>
    <script>
        let player, globalCanvas, htmlRoot, controller, one_step, file_drop, proj_name, stt_name, combobox;
        const stdlibPromise = StratumPlayer.loadLibraryFromUrl("/data/library.zip");
        window.onload = () => {
            globalCanvas = document.getElementById("canvas");
            globalCanvas.width = window.innerWidth - 40;
            globalCanvas.height = window.innerHeight - 100;
            file_drop = document.getElementById("file_drop")
            proj_name = document.getElementById("proj_name");
            stt_name = document.getElementById("stt_name");
            combobox = document.getElementById("combobox");
            file_drop.addEventListener("change", e => play("file", e.target.files));
            combobox.addEventListener("change", e => play("ref", e.target.value));
            globalCanvas = document.getElementById("canvas");
            htmlRoot = document.getElementById("root");
            controller = document.getElementById("controller");
            one_step = document.getElementById("one_step");
        };
        async function play(type, value) {
            if (!value) return;
            const projectFile = proj_name.value;
            const sttFile = stt_name.value;
            file_drop.remove();
            proj_name.remove();
            stt_name.remove();
            combobox.remove();
            const preloadedLibs = await stdlibPromise;
            console.log("Стандартная библиотека имиджей загружена");
            controller.removeAttribute("hidden");
            one_step.removeAttribute("hidden");
            const checkErrors = (err) => { console.log(err); return true; };
            const opts = { globalCanvas, htmlRoot, preloadedLibs, projectFile, sttFile, checkErrors };
            const getPlayer = type === "file" ? StratumPlayer.fromFileList(value, opts) : StratumPlayer.fromUrl(`projects/${value}.zip`, opts);
            getPlayer.then(p => {
                if (player) player.stopPlay();
                player = p;
                controller.innerHTML = "Пауза";
                if (!p) return;
                controller.addEventListener("click", () => {
                    if(player.playing) {
                        player.stopPlay();
                        controller.innerHTML = "Продолжить";
                    } else {
                        player.play();
                        controller.innerHTML = "Пауза";
                    }
                });
                one_step.addEventListener("click", () => {
                    player.oneStep();
                    controller.innerHTML = "Продолжить";
                });
                p
                    .on("WINDOW_CREATED", name => document.title = name)
                    .on("PROJECT_STOPPED", () => alert("Проект остановлен"))
                    .on("VM_ERROR", (err) => {
                        console.error(err);
                        alert("Возникли ошибки, см. в консоли (F12)");
                    })
                    .play();

            });
        }
    </script>
</head>
<body>
    <a>Версия 4.0</a>
    <input id="file_drop" type="file" accept=".zip" />
    <button id="one_step" hidden style="height: 50px">Один шаг</button>
    <button id="controller" hidden style="height: 50px">Пауза</button>
    <input id="proj_name" type="text" placeholder="название файла проекта"></input>
	<input id="stt_name" type="text" placeholder="название файла переменных"></input>
    <select id="combobox">
        <option value="" disabled selected>Выберите проект</option>
        <option value="myach">Интерактивная физика - мяч</option>
        <option value="balls">Много мячиков</option>
        <option value="balls2">Мячики</option>
        <option value="diagram">Круговая диаграмма</option>
        <option value="sqr">Квадратное уравнение</option>
        <option value="25d">2,5d</option>
        <option value="solar">Солнечная система</option>
      </select>
    <div id="root" style="position:relative;">
        <canvas id="canvas" width="900" height="900" style="border:1px solid #000000;"></canvas>
    </div>
</body>
